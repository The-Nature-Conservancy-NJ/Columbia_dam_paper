"0","library(dplyr)"
"0","library(knitr)"
"0","library(tidyr)"
"0","library(kableExtra)"
"0","library(wesanderson)"
"0","library(lubridate)"
"0","library(ggplot2)"
"0","library(forcats)"
"0","library(lme4)"
"0","library(here)"
"0","library(ggpubr)"
"0","library(grid)"
"0","library(scales)"
"0","library(readxl)"
"0","library(here)"
"0","library(lubridate)"
"0","library(GGally)"
"0","library(fmsb)"
"0","library(dataRetrieval)"
"0","library(Kendall)"
"0","library(ggeffects)"
"0","library(dfoptim)"
"0",""
"0","'%notin%' <- Negate('%in%')"
"0","task_path <- ""output/Columbia_paper_figs_analysis/"""
"0",""
"0","# read in compiled logger data (including flagged data)"
"0","p <- readRDS(""output/compiled_logger_data.rds"") %>%"
"0","  mutate(order = as.numeric(substr(site, 5, 6)),"
"0","         site = fct_reorder(site, order))"
"0",""
"0","# format final compiled temperature data"
"0","tdata <- p %>%"
"0","  filter(FLAG_Temp == 0) %>%"
"0","  mutate(day = yday(datetime),"
"0","         month = month(datetime),"
"0","         hour = hour(datetime),"
"0","         minute = minute(datetime),"
"0","         dtime = hour + minute/60) %>%"
"0","  # remove obvious outliers at start of time series"
"0","  filter(as.logical(1-(site == ""TNC_25"" & "
"0","                         year == 2018 & "
"0","                         day == 122))) %>%"
"0","  filter(as.logical(1-(site == ""TNC_23"" & "
"0","                         year == 2018 & "
"0","                         day == 122))) %>%"
"0","  filter(as.logical(1-(site == ""TNC_23"" & "
"0","                         year == 2021 & "
"0","                         day == 118))) %>%"
"0","  arrange(site, year, day) %>%"
"0","  # peak movement ~ 15 April - 15 May in Raritan per Anthony V."
"0","  mutate(season = case_when(day %in% 105:135 ~ ""migrate"", #4/15-5/15"
"0","                            day %in% 136:151 ~ ""spawn"", #5/16-5/31"
"0","                            day %in% 152:181 ~ ""larvae"", #6/1-6/30"
"0","                            day %in% 182:258 ~ ""juvenile"", #7/1-9/15"
"0","                            day %in% 259:334 ~ ""fall_mig""), #9/15-11"
"0","         yearf = as.factor(year),"
"0","         dayf = as.factor(day),"
"0","         hourf = as.factor(hour),"
"0","         season = as.factor(season))"
"0",""
"0","# Columbia Dam - Temperature"
"0","    # upstream: TNC_23, downstream: TNC_25 (& 24), in: 80 & 81"
"0","col <- tdata %>%"
"0","  filter(site %in% c(""TNC_23"", ""TNC_25"", "
"0","                     ""TNC_24"", ""TNC_81"", ""TNC_80"")) %>%"
"0","  mutate(monthf = as.factor(month)) %>%"
"0","    group_by(site, yearf, monthf, dayf, hourf) %>%"
"0","  summarize(mean_temp = mean(temp),"
"0","            .groups = ""drop"") %>%"
"0","  group_by(site, yearf, monthf, dayf) %>%"
"0","  summarize(mean_temp = mean(mean_temp),"
"0","            .groups = ""drop"") %>%"
"0","  tidyr::pivot_wider(names_from = ""site"", "
"0","                     values_from = ""mean_temp"") %>%"
"0","  mutate(d25.23 = TNC_25-TNC_23,"
"0","         d25.80 = TNC_25-TNC_80,"
"0","         d25.81 = TNC_25-TNC_81,"
"0","         stage = as.factor(case_when(yearf %in% 2016:2017 ~ 1,"
"0","                           yearf == 2018 & as.numeric(as.character(monthf))<7~1,"
"0","                           yearf == 2018 & as.numeric(as.character(monthf))>=7 |"
"0","                             yearf == 2019 & as.numeric(as.character(monthf))<5~2,"
"0","                           yearf == 2019 & as.numeric(as.character(monthf))>=5~3,"
"0","                           yearf %in% 2020:2051 ~ 3))"
"0","         )"
"0",""
"0","# Tree planting area - Temperature"
"0","    # upstream: TNC_4, within: TNC_5, downstream: TNC_8"
"0","tree <- tdata %>%"
"0","  filter(site %in% c(""TNC_4"", ""TNC_5"", ""TNC_8"")) %>%"
"0","  mutate(monthf = as.factor(month)) %>%"
"0","    group_by(site, yearf, monthf, dayf, hourf) %>%"
"0","  summarize(mean_temp = mean(temp),"
"0","            .groups = ""drop"") %>%"
"0","  group_by(site, yearf, monthf, dayf) %>%"
"0","  summarize(mean_temp = mean(mean_temp),"
"0","            .groups = ""drop"") %>%"
"0","  tidyr::pivot_wider(names_from = ""site"", "
"0","                     values_from = ""mean_temp"") %>%"
"0","  mutate(d8.4 = TNC_8-TNC_4,"
"0","         d5.4 = TNC_5-TNC_4,"
"0","         d4.8 = TNC_4-TNC_8,"
"0","         d4.5 = TNC_4-TNC_5,"
"0","         stage = as.factor(case_when(yearf %in% 2016:2018 ~ 1,"
"0","                           yearf %in% 2019:2051 ~ 2))"
"0","         )"
"0",""
"0","# format final compiled DO data"
"0","dodata <- p %>%"
"0","  filter(FLAG_DO == 0) %>%"
"0","  mutate(day = yday(datetime),"
"0","         month = month(datetime),"
"0","         hour = hour(datetime),"
"0","         minute = minute(datetime),"
"0","         dtime = hour + minute/60,"
"0","         do_adj2 = case_when((is.na(do)==F & is.na(do_adj)==T) ~"
"0","                               do,"
"0","                             TRUE ~ do_adj),"
"0","         adj = case_when(is.na(do_adj)==F ~ 1,"
"0","                         TRUE ~ 0)) %>%"
"0","  select(-do, -do_adj) %>%"
"0","  rename(do = do_adj2) %>%"
"0","  # right_join(expand.grid(site = unique(p$site), "
"0","  #                        year = 2016:2021, day = 82:339)) %>%"
"0","  arrange(site, year, day) %>%"
"0","    # Dates based on Anthony V. and shad reference he provided"
"0","  mutate(season = case_when(day %in% 105:135 ~ ""migrate"", #4/15-5/15"
"0","                            day %in% 136:151 ~ ""spawn"", #5/16-5/31"
"0","                            day %in% 152:181 ~ ""larvae"", #6/1-6/30"
"0","                            day %in% 182:258 ~ ""juvenile"", #7/1-9/15"
"0","                            day %in% 259:334 ~ ""fall_mig""), #9/15-11"
"0","         yearf = as.factor(year),"
"0","         dayf = as.factor(day),"
"0","         hourf = as.factor(hour))"
"0",""
"0","coldo <- dodata %>%"
"0","  filter(site %in% c(""TNC_23"", ""TNC_25"", "
"0","                     ""TNC_24"", ""TNC_81"", ""TNC_80"")) %>%"
"0","  mutate(monthf = as.factor(month)) %>%"
"0","    group_by(site, yearf, monthf, dayf, hourf) %>%"
"0","  summarize(mean_do = mean(do),"
"0","            .groups = ""drop"") %>%"
"0","  group_by(site, yearf, monthf, dayf) %>%"
"0","  summarize(mean_do = mean(mean_do),"
"0","            .groups = ""drop"") %>%"
"0","  tidyr::pivot_wider(names_from = ""site"", "
"0","                     values_from = ""mean_do"") %>%"
"0","  mutate(d25.23 = TNC_25-TNC_23,"
"0","         d25.80 = TNC_25-TNC_80,"
"0","         d25.81 = TNC_25-TNC_81,"
"0","         stage = as.factor(case_when(yearf %in% 2016:2017 ~ 1,"
"0","                           yearf == 2018 & as.numeric(as.character(monthf))<7~1,"
"0","                           yearf == 2018 & as.numeric(as.character(monthf))>=7 |"
"0","                             yearf == 2019 & as.numeric(as.character(monthf))<5~2,"
"0","                           yearf == 2019 & as.numeric(as.character(monthf))>=5~3,"
"0","                           yearf %in% 2020:2051 ~ 3))"
"0","         )"
"0",""
"0","# Tree planting area - DO"
"0","    # upstream: TNC_4, within: TNC_5, downstream: TNC_8"
"0","treedo <- dodata %>%"
"0","  filter(site %in% c(""TNC_4"", ""TNC_5"", ""TNC_8"")) %>%"
"0","  mutate(monthf = as.factor(month)) %>%"
"0","    group_by(site, yearf, monthf, dayf, hourf) %>%"
"0","  summarize(mean_do = mean(do),"
"0","            .groups = ""drop"") %>%"
"0","  group_by(site, yearf, monthf, dayf) %>%"
"0","  summarize(mean_do = mean(mean_do),"
"0","            .groups = ""drop"") %>%"
"0","  tidyr::pivot_wider(names_from = ""site"", "
"0","                     values_from = ""mean_do"") %>%"
"0","  mutate(d8.4 = TNC_8-TNC_4,"
"0","         d5.4 = TNC_5-TNC_4,"
"0","         d4.8 = TNC_4-TNC_8,"
"0","         d4.5 = TNC_4-TNC_5,"
"0","         stage = as.factor(case_when(yearf %in% 2016:2018 ~ 1,"
"0","                           yearf %in% 2019:2051 ~ 2))"
"0","         )"
"0",""
"0",""
"0","# turbidity data"
"0","turb <- p %>%"
"0","  filter(is.na(turb) == F,"
"0","         FLAG_NTU == 0) %>%"
"0","    mutate(day = yday(datetime),"
"0","         month = month(datetime),"
"0","         hour = hour(datetime),"
"0","         minute = minute(datetime),"
"0","         dtime = hour + minute/60) %>%"
"0","  arrange(site, year, day) %>%"
"0","  mutate(yearf = as.factor(year),"
"0","         dayf = as.factor(day),"
"0","         hourf = as.factor(hour))"
"0",""
"0","# summarize turbidity data for columbia dam"
"0"," colturb <- turb %>%"
"0","  filter(site %in% c(""TNC_23"", ""TNC_25"", "
"0","                     ""TNC_24"", ""TNC_81"", ""TNC_80"")) %>%"
"0","  mutate(monthf = as.factor(month)) %>%"
"0","    group_by(site, yearf, monthf, dayf, hourf) %>%"
"0","  summarize(mean_turb = mean(turb),"
"0","            .groups = ""drop"") %>%"
"0","  group_by(site, yearf, monthf, dayf) %>%"
"0","  summarize(mean_turb = mean(mean_turb),"
"0","            .groups = ""drop"") %>%"
"0","  tidyr::pivot_wider(names_from = ""site"", "
"0","                     values_from = ""mean_turb"") %>%"
"0","  mutate(d25.23 = log(TNC_25)-log(TNC_23),"
"0","         d25.80 = log(TNC_25)-log(TNC_80),"
"0","         d25.81 = log(TNC_25)-log(TNC_81),"
"0","         stage = as.factor(case_when(yearf %in% 2016:2017 ~ 1,"
"0","                           yearf == 2018 & as.numeric(as.character(monthf))<7~1,"
"0","                           yearf == 2018 & as.numeric(as.character(monthf))>=7 |"
"0","                             yearf == 2019 & as.numeric(as.character(monthf))<5~2,"
"0","                           yearf == 2019 & as.numeric(as.character(monthf))>=5~3,"
"0","                           yearf %in% 2020:2051 ~ 3))"
"0","         )"
"0",""
"0"," "
"0","# Paulina Dam - Temperature"
"0","    # upstream: TNC_18, downstream: TNC_19"
"0","pault <- tdata %>%"
"0","  filter(site %in% c(""TNC_18"", ""TNC_19"")) %>%"
"0","  mutate(monthf = as.factor(month)) %>%"
"0","    group_by(site, yearf, monthf, dayf, hourf) %>%"
"0","  summarize(mean_temp = mean(temp),"
"0","            .groups = ""drop"") %>%"
"0","  group_by(site, yearf, monthf, dayf) %>%"
"0","  summarize(mean_temp = mean(mean_temp),"
"0","            .groups = ""drop"") %>%"
"0","  tidyr::pivot_wider(names_from = ""site"", "
"0","                     values_from = ""mean_temp"") %>%"
"0","  mutate(d19.18 = TNC_19-TNC_18)"
"0","         "
"0",""
"0","# Paulina Dam - DO"
"0","    # upstream: TNC_18, downstream: TNC_19"
"0","pauldo <- dodata %>%"
"0","  filter(site %in% c(""TNC_18"", ""TNC_19"")) %>%"
"0","  mutate(monthf = as.factor(month)) %>%"
"0","    group_by(site, yearf, monthf, dayf, hourf) %>%"
"0","  summarize(mean_do = mean(do),"
"0","            .groups = ""drop"") %>%"
"0","  group_by(site, yearf, monthf, dayf) %>%"
"0","  summarize(mean_do = mean(mean_do),"
"0","            .groups = ""drop"") %>%"
"0","  tidyr::pivot_wider(names_from = ""site"", "
"0","                     values_from = ""mean_do"") %>%"
"0","  mutate(d19.18 = TNC_19-TNC_18)"
"0",""
"0","# Paulina Dam - turbidity"
"0","    # upstream: TNC_18, downstream: TNC_19"
"0","paulturb <- turb %>%"
"0","  filter(site %in% c(""TNC_18"", ""TNC_19"")) %>%"
"0","  mutate(monthf = as.factor(month)) %>%"
"0","    group_by(site, yearf, monthf, dayf, hourf) %>%"
"0","  summarize(mean_turb = mean(turb),"
"0","            .groups = ""drop"") %>%"
"0","  group_by(site, yearf, monthf, dayf) %>%"
"0","  summarize(mean_turb = mean(log(mean_turb)),"
"0","            .groups = ""drop"") %>%"
"0","  tidyr::pivot_wider(names_from = ""site"", "
"0","                     values_from = ""mean_turb"") %>%"
"0","  mutate(d19.18 = TNC_19-TNC_18)"
"0",""
"0","#prepare macroinvertebrate data"
"0","source(""scripts/load_monthly_logger_data.R"")"
"0","source(""scripts/future_macro_function.R"")"
"0","source(""scripts/future_hab_function.R"")"
"0",""
"0","# path where the Macroinvertebrate and Habitat Quality data are stored"
"0","mh_path <- ""data/Macro_Habitat"""
"0",""
"0","# Next we read in macroinvertebrate data one year at a time"
"0","  # this was necessary as they all had slightly different formats"
"0",""
"0","# Read in Macroinvertebrate data - 2016"
"0","inv16 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2016_2017.xlsx""),"
"0","                   skip = 2, "
"0","                   sheet = ""macro_2016"""
"0","                   ) %>%"
"0","  select(c(3,4,32:40)) %>%"
"0","  rename(num_gen = 3,"
"0","         pct_noninsect = 4,"
"0","         pct_ept = 5,"
"0","         num_scraper = 6,"
"0","         hilsenhoff = 7,"
"0","         num_talu2 = 8,"
"0","         num_talu3 = 9,"
"0","         index = 10,"
"0","         rating = 11"
"0","         )"
"0",""
"0","# Read in Macroinvertebrate data - 2017"
"0","inv17 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2016_2017.xlsx""),"
"0","                   skip = 3, "
"0","                   sheet = ""macro_2017"""
"0","                   ) %>%"
"0","  select(c(3,4,32:40)) %>%"
"0","  rename(tnc_code = 1,"
"0","         date = 2,"
"0","         num_gen = 3,"
"0","         pct_noninsect = 4,"
"0","         pct_ept = 5,"
"0","         num_scraper = 6,"
"0","         hilsenhoff = 7,"
"0","         num_talu2 = 8,"
"0","         num_talu3 = 9,"
"0","         index = 10,"
"0","         rating = 11"
"0","         )"
"0",""
"0","# Read in Macroinvertebrate data - 2018"
"0","inv18 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2018_2019.xlsx""),"
"0","                   skip = 3, "
"0","                   sheet = ""macro_2018"""
"0","                   ) %>%"
"0","  select(c(3,4,32:40)) %>%"
"0","  rename(tnc_code = 1,"
"0","         date = 2,"
"0","         num_gen = 3,"
"0","         pct_noninsect = 4,"
"0","         pct_ept = 5,"
"0","         num_scraper = 6,"
"0","         hilsenhoff = 7,"
"0","         num_talu2 = 8,"
"0","         num_talu3 = 9,"
"0","         index = 10,"
"0","         rating = 11"
"0","         ) %>%"
"0","  filter(is.na(tnc_code) == F)"
"0",""
"0","# Read in Macroinvertebrate data - 2019"
"0","inv19 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2018_2019.xlsx""),"
"0","                   skip = 2, "
"0","                   sheet = ""macro_2019"""
"0","                   ) %>%"
"0","  select(c(3,4,32:40)+1) %>%"
"0","  rename(num_gen = 3,"
"0","         pct_noninsect = 4,"
"0","         pct_ept = 5,"
"0","         num_scraper = 6,"
"0","         hilsenhoff = 7,"
"0","         num_talu2 = 8,"
"0","         num_talu3 = 9,"
"0","         index = 10,"
"0","         rating = 11"
"0","         )"
"0",""
"0","# Read in Macroinvertebrate data - 2020"
"0","inv20 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2020_2021.xlsx""),"
"0","                   skip = 3, "
"0","                   sheet = ""macro_2020"""
"0","                   ) %>%"
"0","  select(c(3,4,32:40)) %>%"
"0","  rename(tnc_code = 1,"
"0","         date = 2,"
"0","         num_gen = 3,"
"0","         pct_noninsect = 4,"
"0","         pct_ept = 5,"
"0","         num_scraper = 6,"
"0","         hilsenhoff = 7,"
"0","         num_talu2 = 8,"
"0","         num_talu3 = 9,"
"0","         index = 10,"
"0","         rating = 11"
"0","         ) %>%"
"0","  filter(is.na(num_gen) != T)"
"0",""
"0","# Read in Macroinvertebrate data - 2021"
"0","inv21 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2020_2021.xlsx""),"
"0","                   skip = 2, "
"0","                   sheet = ""macro_2021"""
"0","                   ) %>%"
"0","  select(c(3,4,32:40)+1) %>%"
"0","  rename(num_gen = 3,"
"0","         pct_noninsect = 4,"
"0","         pct_ept = 5,"
"0","         num_scraper = 6,"
"0","         hilsenhoff = 7,"
"0","         num_talu2 = 8,"
"0","         num_talu3 = 9,"
"0","         index = 10,"
"0","         rating = 11"
"0","         )"
"0",""
"0","# Check if 2022-2026 macroinvertebrate data exists. If so, then load it."
"0","inv22 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2022_2023.xlsx""),"
"0","                   skip = 3, "
"0","                   sheet = ""macro_2022"""
"0","                   ) %>%"
"0","  select(c(3,4,32:40)) %>%"
"0","  rename(tnc_code = 1,"
"0","         date = 2,"
"0","         num_gen = 3,"
"0","         pct_noninsect = 4,"
"0","         pct_ept = 5,"
"0","         num_scraper = 6,"
"0","         hilsenhoff = 7,"
"0","         num_talu2 = 8,"
"0","         num_talu3 = 9,"
"0","         index = 10,"
"0","         rating = 11"
"0","         ) %>%"
"0","  filter(is.na(num_gen) != T)"
"0",""
"0","#column added before 'tnc_code' so adjusted all 'select' columns up by 1 (e.g., 4 instead of 3 for tnc_code)"
"0","inv23 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2022_2023.xlsx""),"
"0","                   skip = 2, "
"0","                   sheet = ""macro_2023"""
"0","                   ) %>%"
"0","  select(c(4,5,33:41)) %>%"
"0","  rename(num_gen = 3,"
"0","         pct_noninsect = 4,"
"0","         pct_ept = 5,"
"0","         num_scraper = 6,"
"0","         hilsenhoff = 7,"
"0","         num_talu2 = 8,"
"0","         num_talu3 = 9,"
"0","         index = 10,"
"0","         rating = 11"
"0","         )"
"0",""
"0","#another column was added- 'client sample id' so column numbers in 'select' needed to be adjusted to 33:41 instead of 32:40"
"0","inv24 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2024_2025.xlsx""),"
"0","                   skip = 3, "
"0","                   sheet = ""macro_2024"""
"0","                   ) %>%"
"0","  select(c(3,4,33:41)) %>%"
"0","  rename(tnc_code = 1,"
"0","         date = 2,"
"0","         num_gen = 3,"
"0","         pct_noninsect = 4,"
"0","         pct_ept = 5,"
"0","         num_scraper = 6,"
"0","         hilsenhoff = 7,"
"0","         num_talu2 = 8,"
"0","         num_talu3 = 9,"
"0","         index = 10,"
"0","         rating = 11"
"0","         ) %>%"
"0","  filter(is.na(num_gen) != T)"
"0",""
"0",""
"0","# Compile all Macroinvertebrate data into one data frame"
"0","inv <- inv16 %>%"
"0","  bind_rows(inv17) %>%"
"0","  bind_rows(inv18) %>%"
"0","  bind_rows(inv19) %>%"
"0","  bind_rows(inv20) %>%"
"0","  bind_rows(inv21) %>%"
"0","  bind_rows(inv22) %>%"
"0","  bind_rows(inv23) %>%"
"0","  bind_rows(inv24) %>%"
"0","  mutate(year = year(date),"
"0","         yearf = as.factor(year)) %>%"
"0","  mutate(yearf = fct_reorder(yearf, index, .fun = ""mean""),"
"0","         tnc_code = fct_reorder(tnc_code, index, .fun = ""mean""),"
"0","         rating = case_when(rating == ""EXCELLENT"" ~ ""Excellent"","
"0","                            rating == ""GOOD"" ~ ""Good"","
"0","                            rating == ""FAIR"" ~ ""Fair"","
"0","                            rating == ""POOR"" ~ ""Poor"","
"0","                            TRUE ~ rating))"
"0",""
"0","# remove data frames of individual years"
"0","rm(inv16, inv17, inv18, inv19, inv20, inv21,"
"0","   inv22, inv23, inv24)"
"0",""
"0","# Next we read in habitat data one year at a time"
"0","  # this was necessary as they all had slightly different formats"
"0",""
"0","# Read in habitat data - 2016"
"0","hab16 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2016_2017.xlsx""),"
"0","                   skip = 0, "
"0","                   sheet = ""Habitat_2016"""
"0","                   ) %>%"
"0","  select(c(3:17,19:20)) %>%"
"0","  rename(epifaunal_sub = 3,"
"0","         pool_sub = 4,"
"0","         pool_var = 5,"
"0","         sed_dep = 6,"
"0","         channel_flow = 7,"
"0","         channel_alt = 8,"
"0","         channel_sin = 9,"
"0","         bank_stab_l = 10,"
"0","         bank_stab_r = 11,"
"0","         bank_veg_l = 12,"
"0","         bank_veg_r = 13,"
"0","         rip_veg_l = 14,"
"0","         rip_veg_r = 15)"
"0",""
"0","# Read in habitat data - 2017"
"0","hab17 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2016_2017.xlsx""),"
"0","                   skip = 0, "
"0","                   sheet = ""Habitat_2017"""
"0","                   ) %>%"
"0","  select(c(3:17,19:20)) %>%"
"0","  rename(epifaunal_sub = 3,"
"0","         pool_sub = 4,"
"0","         pool_var = 5,"
"0","         sed_dep = 6,"
"0","         channel_flow = 7,"
"0","         channel_alt = 8,"
"0","         channel_sin = 9,"
"0","         bank_stab_l = 10,"
"0","         bank_stab_r = 11,"
"0","         bank_veg_l = 12,"
"0","         bank_veg_r = 13,"
"0","         rip_veg_l = 14,"
"0","         rip_veg_r = 15)"
"0",""
"0","# Read in habitat data - 2018"
"0","hab18 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2018_2019.xlsx""),"
"0","                   skip = 0, "
"0","                   sheet = ""Habitat_2018"""
"0","                   ) %>%"
"0","  select(c(3:17,19:20)) %>%"
"0","  rename(epifaunal_sub = 3,"
"0","         pool_sub = 4,"
"0","         pool_var = 5,"
"0","         sed_dep = 6,"
"0","         channel_flow = 7,"
"0","         channel_alt = 8,"
"0","         channel_sin = 9,"
"0","         bank_stab_l = 10,"
"0","         bank_stab_r = 11,"
"0","         bank_veg_l = 12,"
"0","         bank_veg_r = 13,"
"0","         rip_veg_l = 14,"
"0","         rip_veg_r = 15)"
"0",""
"0","# note: I fixed a typo in Habitat_2019 tab manually:"
"0","#         TNC_6	4/12/2019 was TNC_6	4/12/12019"
"0","# Read in habitat data - 2019"
"0","hab19 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2018_2019.xlsx""),"
"0","                   skip = 0, "
"0","                   sheet = ""Habitat_2019"""
"0","                   ) %>%"
"0","  select(c(3:17,19:20)) %>%"
"0","  rename(epifaunal_sub = 3,"
"0","         pool_sub = 4,"
"0","         pool_var = 5,"
"0","         sed_dep = 6,"
"0","         channel_flow = 7,"
"0","         channel_alt = 8,"
"0","         channel_sin = 9,"
"0","         bank_stab_l = 10,"
"0","         bank_stab_r = 11,"
"0","         bank_veg_l = 12,"
"0","         bank_veg_r = 13,"
"0","         rip_veg_l = 14,"
"0","         rip_veg_r = 15)"
"0",""
"0","# Read in habitat data - 2020"
"0","hab20 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2020_2021.xlsx""),"
"0","                   skip = 0, "
"0","                   sheet = ""Habitat_2020"""
"0","                   ) %>%"
"0","  select(c(3:17,18,20)) %>%"
"0","  rename(epifaunal_sub = 3,"
"0","         pool_sub = 4,"
"0","         pool_var = 5,"
"0","         sed_dep = 6,"
"0","         channel_flow = 7,"
"0","         channel_alt = 8,"
"0","         channel_sin = 9,"
"0","         bank_stab_l = 10,"
"0","         bank_stab_r = 11,"
"0","         bank_veg_l = 12,"
"0","         bank_veg_r = 13,"
"0","         rip_veg_l = 14,"
"0","         rip_veg_r = 15,"
"0","         habitat_score = 16)"
"0",""
"0","# Read in habitat data - 2021"
"0","hab21 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2020_2021.xlsx""),"
"0","                   skip = 0, "
"0","                   sheet = ""Habitat_2021"""
"0","                   ) %>%"
"0","  select(c(3:17,19:20)) %>%"
"0","  rename(epifaunal_sub = 3,"
"0","         pool_sub = 4,"
"0","         pool_var = 5,"
"0","         sed_dep = 6,"
"0","         channel_flow = 7,"
"0","         channel_alt = 8,"
"0","         channel_sin = 9,"
"0","         bank_stab_l = 10,"
"0","         bank_stab_r = 11,"
"0","         bank_veg_l = 12,"
"0","         bank_veg_r = 13,"
"0","         rip_veg_l = 14,"
"0","         rip_veg_r = 15)"
"0",""
"0","# Check if 2022-2026 habitat data exists. If so, then load it."
"0","hab22 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2022_2023.xlsx""),"
"0","                   skip = 0, "
"0","                   sheet = ""Habitat_2022"""
"0","                   ) %>%"
"0","  select(c(3:17,18,20)) %>%"
"0","  rename(epifaunal_sub = 3,"
"0","         pool_sub = 4,"
"0","         pool_var = 5,"
"0","         sed_dep = 6,"
"0","         channel_flow = 7,"
"0","         channel_alt = 8,"
"0","         channel_sin = 9,"
"0","         bank_stab_l = 10,"
"0","         bank_stab_r = 11,"
"0","         bank_veg_l = 12,"
"0","         bank_veg_r = 13,"
"0","         rip_veg_l = 14,"
"0","         rip_veg_r = 15,"
"0","         habitat_score = 16)"
"0",""
"0","hab23 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2022_2023.xlsx""),"
"0","                   skip = 0, "
"0","                   sheet = ""Habitat_2023"""
"0","                   ) %>%"
"0","  select(c(3:17,18,20)) %>%"
"0","  rename(epifaunal_sub = 3,"
"0","         pool_sub = 4,"
"0","         pool_var = 5,"
"0","         sed_dep = 6,"
"0","         channel_flow = 7,"
"0","         channel_alt = 8,"
"0","         channel_sin = 9,"
"0","         bank_stab_l = 10,"
"0","         bank_stab_r = 11,"
"0","         bank_veg_l = 12,"
"0","         bank_veg_r = 13,"
"0","         rip_veg_l = 14,"
"0","         rip_veg_r = 15,"
"0","         habitat_score = 16)"
"0",""
"0","hab24 <- read_xlsx(here(mh_path,"
"0","                        ""macro_habitat_data_2024_2025.xlsx""),"
"0","                   skip = 0, "
"0","                   sheet = ""Habitat_2024"""
"0","                   ) %>%"
"0","  select(c(3:17,18,20)) %>%"
"0","  rename(epifaunal_sub = 3,"
"0","         pool_sub = 4,"
"0","         pool_var = 5,"
"0","         sed_dep = 6,"
"0","         channel_flow = 7,"
"0","         channel_alt = 8,"
"0","         channel_sin = 9,"
"0","         bank_stab_l = 10,"
"0","         bank_stab_r = 11,"
"0","         bank_veg_l = 12,"
"0","         bank_veg_r = 13,"
"0","         rip_veg_l = 14,"
"0","         rip_veg_r = 15,"
"0","         habitat_score = 16)"
"0",""
"0",""
"0",""
"0","# Compile all Habitat data into one data frame"
"0","hab <- hab16 %>%"
"0","  bind_rows(hab17) %>%"
"0","  bind_rows(hab18) %>%"
"0","  bind_rows(hab19) %>%"
"0","  bind_rows(hab20) %>%"
"0","  bind_rows(hab21) %>%"
"0","  bind_rows(hab22) %>%"
"0","  bind_rows(hab23) %>%"
"0","  bind_rows(hab24) %>%"
"0","  rename(date = date_collected) %>%"
"0","  mutate(year = year(date),"
"0","         yearf = as.factor(year)) %>%"
"0","  mutate(yearf = fct_reorder(yearf, habitat_score, .fun = ""mean""),"
"0","         tnc_code = fct_reorder(tnc_code, habitat_score, "
"0","                                .fun = ""mean""),"
"0","         rip_veg = rip_veg_r + rip_veg_l,"
"0","         bank_veg = bank_veg_r + bank_veg_l,"
"0","         bank_stab = bank_stab_r + bank_stab_l) %>%"
"0","  select(-c(bank_stab_l, bank_stab_r,"
"0","            bank_veg_l, bank_veg_r,"
"0","            rip_veg_l, rip_veg_r)) %>%"
"0","  mutate(habitat_rating = case_when(habitat_rating == ""OPTIMAL"" ~"
"0","                                      ""Optimal"","
"0","                                    habitat_rating == ""SUB-OPTIMAL"" ~"
"0","                                      ""Sub-Optimal"","
"0","                                    TRUE ~ habitat_rating))"
"0",""
"0","# remove data frames of individual years"
"0","rm(hab16, hab17, hab18, hab19, hab20, hab21,"
"0","   hab22, hab23, hab24)"
"0",""
"0","# Create data frame of mean July temperatures for each site"
"0","tsum_july <- tsum_month %>%"
"0","  filter(Month == ""July"") %>%"
"0","  group_by(site) %>%"
"0","  summarise(mean_july_temp = mean(mean_mean),"
"0","            .groups = ""drop"") %>%"
"0","  rename(tnc_code = site)"
"0",""
"0","# Create data frame of mean July DO for each site"
"0","dosum_july <- dosum_month %>%"
"0","  filter(month == 7) %>%"
"0","  group_by(site) %>%"
"0","  summarise(mean_july_do = mean(mean_mean),"
"0","            .groups = ""drop"") %>%"
"0","  rename(tnc_code = site)"
"0",""
"0","# combine habitat, macroinvertebrate, mean July temp & DO data"
"0","hab.inv <- hab %>%"
"0","  left_join(inv, by = c(""tnc_code"", ""year"", ""yearf"")) %>%"
"0","  group_by(tnc_code) %>%"
"0","  summarize(index_mean = mean(index, na.rm = T),"
"0","            index_min = min(index, na.rm = T),"
"0","            index_max = max(index, na.rm = T),"
"0","            index_n = sum(is.na(index)==F),"
"0","            hab_mean = mean(habitat_score, na.rm = T),"
"0","            hab_min = min(habitat_score, na.rm = T),"
"0","            hab_max = max(habitat_score, na.rm = T),"
"0","            hab_n = sum(is.na(habitat_score)==F)) %>%"
"0","  mutate(index_n2 = paste0(c(rep("""",20),""n = ""), index_n),"
"0","         hab_n2 = paste0(c(rep("""",20),""n = ""), hab_n),"
"0","         num = gsub(tnc_code, pattern = ""TNC_"", "
"0","                    replacement = """")) %>%"
"0","  left_join(tsum_july, by = ""tnc_code"") %>%"
"0","  left_join(dosum_july, by = ""tnc_code"")"
"0",""
"0","exclude <- c(""TNC_2"", ""TNC_10"", ""TNC_8"", "
"0","             ""TNC_5"", ""TNC_4"", ""TNC_28"")"
"0",""
"0","# format final compiled temperature data for migratory analyses"
"0","tdata <- p %>%"
"0","  filter(FLAG_Temp == 0) %>%"
"0","  mutate(day = yday(datetime),"
"0","         month = month(datetime),"
"0","         hour = hour(datetime),"
"0","         minute = minute(datetime),"
"0","         dtime = hour + minute/60) %>%"
"0","  # remove obvious outliers at start of time series"
"0","  filter(as.logical(1-(site == ""TNC_25"" & "
"0","                         year == 2018 & "
"0","                         day == 122))) %>%"
"0","  filter(as.logical(1-(site == ""TNC_23"" & "
"0","                         year == 2018 & "
"0","                         day == 122))) %>%"
"0","  filter(as.logical(1-(site == ""TNC_23"" & "
"0","                         year == 2021 & "
"0","                         day == 118))) %>%"
"0","  arrange(site, year, day) %>%"
"0","  # peak movement ~ 15 April - 15 May in Raritan per RU data"
"0","  # dates als based on MD extension ref"
"0","  mutate(season = case_when(day %in% 105:135 ~ ""migrate"", #4/15-5/15"
"0","                            day %in% 136:151 ~ ""spawn"", #5/16-5/31"
"0","                            day %in% 152:181 ~ ""larvae"", #6/1-6/30"
"0","                            day %in% 182:258 ~ ""juvenile"", #7/1-9/15"
"0","                            day %in% 259:334 ~ ""fall_mig""), #9/15-11"
"0","         yearf = as.factor(year),"
"0","         dayf = as.factor(day),"
"0","         hourf = as.factor(hour),"
"0","         season = as.factor(season))"
"2","Error: object 'p' not found
"
